---
description: Decentralize the Infrastructure
---

# Consensus Protocol

The consensus protocol in the Hydrogen Network makes sure no one could cheat the network, where everyone could freely join the network, and do whatever they want.

For example, a malicious node could submit a random image to the network without actually perform the computation. If we leave the mission of discovering the cheating to the user, i.e. allowing the user to pay only after he verified the result image, then a malicious user could deny all the payment to use the network for free.

The goal of the the consensus protocol in the Hydrogen Network is to find out whether an image is the correct output of a task, given the task arguments and the image. And if the image is correct, make sure the Node who summited the correct image get paid.

The consensus protocol must be implemented using the smart contracts, and executed on the Blockchain, so that we don't need a trusted central party to enforce the execution of the protocol, who will be cheating himself given so much power.

## Result Validation by Voting

The result validation is simply implemented by comparing 3 results from 3 randomly selected Nodes. When the task is submitted to the Blockchain by the application, the Blockchain randomly selects 3 available Nodes, and notifies them to start the task. The Nodes run the task locally, and submit the results to the Blockchain. The Blockchain will compare the results to find out whether the Nodes are cheating or not.

#### Similarity Comparison of the Images

Due to some technical limitations, such as [this](https://github.com/pytorch/pytorch/issues/87992) ,and [this](https://pytorch.org/docs/stable/notes/randomness.html). It it nearly impossible to generate two exactly same images on two different devices. We could say that the randomness is the nature in the machine learning world.

Luckily, we don't need the images to be exactly the same. If we could compute a similarity score between two results, and the score is high, the results are already **satisfied** to the application.&#x20;

And yes, there will be some lower cost methods to generate a similar image than performing the actual SD computation, but as long as the result is similar enough to be accepted by the application, it is fine to the network.

The Hydrogen Network uses the [Perceptual Hash](https://apiumhub.com/tech-blog-barcelona/introduction-perceptual-hashes-measuring-similarity/), or pHash, to calculate the image similarity. The Node submits the pHash of the images to the Blockchain, and the Blockchain calculates the [Hamming Distance](https://en.wikipedia.org/wiki/Hamming\_distance) between two pHashes as the similarity score.

#### Two Phases Result Disclosure On-Chain

The pHash should not be submitted to the Blockchain directly, since a malicious Node might intercept the pHash from other nodes, and submit it to the Blockchain as it is generated by itself.

A two phase commitment-disclosure process is used to tackle this problem.

* **Phase 1 - Submitting the commitment on-chain**

The Node should generated a random number locally, calculate the hash of the pHash concatenated by the random number, as the commitment, and then submit the commitment and the random number on-chain.

```javascript
random_number = generate_random_number()
commitment = hash(p_hash + random_number)
```

The commitment will not leak any information about the pHash. And the Blockchain will wait for all the 3 Nodes to submit their commitments and the corresponding random numbers on-chain, and then go into phase 2.

* **Phase 2 - Disclose the pHash on-chain**

The honest Nodes could safely submit their pHash to the Blockchain now. The Blockchain will validate the pHash using the commitment and the random number that have been submitted on-chain in the last step. If the validation passes, the Blockchain goes into the next step to compare the pHashes between the Nodes, otherwise, the Blockchain will reject the pHash.

The malicious Node could not learn anything about the pHashes of other nodes in the last step, before it has to submit a wrong commitment on-chain. Now that the malicious Node has already submitted a wrong commitment, even if the malicious Node could intercept a correct pHash from another Node at phase 2, it is too late since he can not use the correct pHash to pass the validation with the wrong commitment on-chain.&#x20;

#### Random Number Generation on the Blockchain

#### Sequential Node Selection

## Staking based Cheating Prevention

## Task Error and Timeout


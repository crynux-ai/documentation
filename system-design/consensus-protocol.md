---
description: Decentralize the Infrastructure
---

# Consensus Protocol

The consensus protocol in the Hydrogen Network makes sure no one could cheat the network, where everyone could freely join the network, and do whatever they want.

For example, a malicious node could submit a random image to the network without actually perform the computation. If we leave the mission of discovering the cheating to the user, i.e. allowing the user to pay only after he verified the result image, then a malicious user could deny all the payment to use the network for free.

The goal of the the consensus protocol in the Hydrogen Network is to find out whether an image is the correct output of a task, given the task arguments and the image. And if the image is correct, make sure the Node who summited the correct image get paid.

The consensus protocol must be implemented using the smart contracts, and executed on the Blockchain, so that we don't need a trusted central party to enforce the execution of the protocol, who will be cheating himself given so much power.

## Result Validation by Voting

The result validation is simply implemented by comparing 3 results from 3 randomly selected Nodes. When the task is submitted to the Blockchain by the application, the Blockchain randomly selects 3 available Nodes, and notifies them to start the task. The Nodes run the task locally, and submit the results to the Blockchain. The Blockchain will compare the results to find out whether the Nodes are cheating or not.

### Similarity Comparison of the Images

Due to some technical limitations, such as [this](https://github.com/pytorch/pytorch/issues/87992) ,and [this](https://pytorch.org/docs/stable/notes/randomness.html). It it nearly impossible to generate two exactly same images on two different devices. We could say that the randomness is the nature in the machine learning world.

Luckily, we don't need the images to be exactly the same. If we could compute a similarity score between two results, and the score is high, the results are already **satisfied** to the application.

And yes, there will be some lower cost methods to generate a similar image than performing the actual SD computation, but as long as the result is similar enough to be accepted by the application, it is fine to the network.

The Hydrogen Network uses the [Perceptual Hash](https://apiumhub.com/tech-blog-barcelona/introduction-perceptual-hashes-measuring-similarity/), or pHash, to calculate the image similarity. The Node submits the pHash of the images to the Blockchain, and the Blockchain calculates the [Hamming Distance](https://en.wikipedia.org/wiki/Hamming\_distance) between two pHashes as the similarity score.

### Two Phases Result Disclosure On-Chain

The pHash should not be submitted to the Blockchain directly, since a malicious Node might intercept the pHash from other nodes, and submit it to the Blockchain as it is generated by itself.

A two phase commitment-disclosure process is used to tackle this problem.

#### **Phase 1 - Submit the commitment on-chain**

The Node should generated a random number locally, calculate the hash of the pHash concatenated by the random number, as the commitment, and then submit the commitment and the random number on-chain.

```javascript
random_number = generate_random_number()
commitment = hash(p_hash + random_number)
submit_to_the_blockchain(commitment, random_number)
```

The commitment will not leak any information about the pHash. And the Blockchain will wait for all the 3 Nodes to submit their commitments and the corresponding random numbers on-chain, and then go into phase 2.

#### **Phase 2 - Disclose the pHash on-chain**

The honest Nodes could safely submit their pHash to the Blockchain now. The Blockchain will validate the pHash using the commitment and the random number that have been submitted on-chain in the last step. If the validation passes, the Blockchain goes into the next step to compare the pHashes between the Nodes, otherwise, the Blockchain will reject the pHash.

The malicious Node could not learn anything about the pHashes of other nodes in the last step, before it has to submit a wrong commitment on-chain. Now that the malicious Node has already submitted a wrong commitment, even if the malicious Node could intercept a correct pHash from another Node at phase 2, it is too late since he can not use the correct pHash to pass the validation with the wrong commitment on-chain.

### Random Number Generation on the Blockchain

Generating random numbers on the Blockchain is then a critical step to the security of the whole network. Ethereum now has the support of `prevrando`, which can be used as the source of the random number. On the other Blockchains, the block hash of the last confirmed block is usually used. More advanced (and complex) methods exist such as the [Verifiable Random Functions](https://en.wikipedia.org/wiki/Verifiable\_random\_function). However, strictly speaking, none of these methods are safe enough in our scenario.

The attack one could perform, given that the result validation is effective, is for an attacker to host more Nodes by himself, and try to have two or more of his own Nodes selected for a single task. In which case the attacker could submit two identical fake results to cheat the Blockchain.

If a Hydrogen Node is hosting the Blockchain node (and producing the blocks) itself, the last block hash, or `prevrando`, or the selection of the VRF, is known to the Node before the `CreateTask` transaction has been confirmed by the next block.  Which leaves a chance for the Node to find out if it is selected for a task ahead of time.

Given the attacking method above, the Node could then reject the `CreateTask` transactions in which it can not cheat, i.e. not having two or more of his own Nodes selected in the task.

By carefully constructing and organizing more adjacent blocks, the Node could even control who will be selected in the next task. Note that this does not apply to the VRF method, where the source of the randomness is not from the Blockchain. Which is immune to this kind of attack, but introduces other risks which we will not cover in this article.

Considering that to make this attack **practical**, the attacker must control a significant large number of Nodes in the whole network by himself. The Hydrogen Network chooses to ignore this situation and uses a simple system architecture of using the `prevrando` on the supported Blockchains, and the last block hash on other platforms.

### Sequential Node Selection

Even if the attacker can not manipulate the selection result of the task, he could adopt the strategy that when he has only one node selected in a task, he will perform the computation honestly. However, he will skip the computation and submit fake results when he has two or more Nodes selected. The system has no way to identify this behavior.

The idea is to avoid any chance, for anyone, to find out whether two of his Nodes are executing the same task. The selected addresses could be hidden from the public by using the VRF, the task ID could even be hidden from the selected Nodes by using the ZKP. The malicious attacker could still find out whether two of his Nodes are executing the same task by comparing the task arguments.

The only option left for us is the sequential node selection. The Blockchain will select one node at a time, and wait until the selected node has submitted the commitment, and then start the selection again. When a Node of the attacker has been selected to run the task, the attacker has no way to find out if his Node will be selected again in the next round. Then the attacker does not have the confidence to submit a fake result at this step.

Even if the Node of the attacker has been selected twice in a single task. When the attacker finds out that he is selected again in the second selection round, since the commitment of a correct result has already been submitted in the previous round, it is already too late for the attacker to submit fake results.

The sequential node selection could solve the problem, but it significantly increases the execution time of a task by around 3 times of the time required in the parallel selection. And just like the random number manipulation attack above, to make this attack practical, the attacker must control a significant large number of Nodes in the whole network by himself, so we decide to ignore it in the Hydrogen Network, using a parallel execution schema, which makes the experience better for the applications and their users.

## Staking based Penalization

### The Expectation of the Income

## Task Error and Timeout

